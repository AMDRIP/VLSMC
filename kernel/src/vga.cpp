#include "kernel/vga.h"
#include "kernel/pic.h"
#include "libc.h"

namespace re36 {

bool VGA::graphics_mode_ = false;
uint8_t* VGA::framebuffer_ = (uint8_t*)VGA_FBADDR;

static const uint8_t font8x8[128][8] = {
    {0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},
    {0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},{0},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00},
    {0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00},
    {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00},
    {0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x00},
    {0x62,0x66,0x0C,0x18,0x30,0x66,0x46,0x00},
    {0x3C,0x66,0x3C,0x38,0x67,0x66,0x3F,0x00},
    {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00},
    {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00},
    {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00},
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30},
    {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
    {0x02,0x06,0x0C,0x18,0x30,0x60,0x40,0x00},
    {0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00},
    {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00},
    {0x3C,0x66,0x06,0x0C,0x18,0x30,0x7E,0x00},
    {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00},
    {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00},
    {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00},
    {0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00},
    {0x7E,0x06,0x0C,0x18,0x30,0x30,0x30,0x00},
    {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00},
    {0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00},
    {0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00},
    {0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00},
    {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00},
    {0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00},
    {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00},
    {0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00},
    {0x3C,0x66,0x6E,0x6A,0x6E,0x60,0x3E,0x00},
    {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00},
    {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00},
    {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00},
    {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00},
    {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00},
    {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00},
    {0x3E,0x60,0x60,0x6E,0x66,0x66,0x3E,0x00},
    {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00},
    {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    {0x06,0x06,0x06,0x06,0x06,0x66,0x3C,0x00},
    {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00},
    {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00},
    {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00},
    {0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00},
    {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00},
    {0x3C,0x66,0x66,0x66,0x6A,0x6C,0x36,0x00},
    {0x7C,0x66,0x66,0x7C,0x6C,0x66,0x66,0x00},
    {0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00},
    {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
    {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00},
    {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00},
    {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00},
    {0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00},
    {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00},
    {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00},
    {0x40,0x60,0x30,0x18,0x0C,0x06,0x02,0x00},
    {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00},
    {0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    {0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00},
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00},
    {0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00},
    {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00},
    {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00},
    {0x1C,0x30,0x7C,0x30,0x30,0x30,0x30,0x00},
    {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C},
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00},
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00},
    {0x0C,0x00,0x1C,0x0C,0x0C,0x0C,0x0C,0x38},
    {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00},
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    {0x00,0x00,0x66,0x7F,0x6B,0x63,0x63,0x00},
    {0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00},
    {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00},
    {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60},
    {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06},
    {0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x00},
    {0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00},
    {0x30,0x30,0x7C,0x30,0x30,0x30,0x1C,0x00},
    {0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00},
    {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00},
    {0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00},
    {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00},
    {0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x3C},
    {0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00},
    {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00},
    {0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
    {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00},
    {0x00,0x00,0x32,0x7F,0x4C,0x00,0x00,0x00},
    {0}
};

static const uint8_t mode13h_regs[] = {
    0x63,
    0x03,0x01,0x0F,0x00,0x0E,
    0x5F,0x4F,0x50,0x82,0x54,0x80,0xBF,0x1F,
    0x00,0x41,0x00,0x00,0x00,0x00,0x00,0x00,
    0x9C,0x0E,0x8F,0x28,0x40,0x96,0xB9,0xA3,0xFF,
    0x00,0x00,0x00,0x00,0x00,0x40,0x05,0x0F,0xFF,
    0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,
    0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
    0x41,0x00,0x0F,0x00,0x00
};

static const uint8_t mode03h_regs[] = {
    0x67,
    0x03,0x00,0x03,0x00,0x02,
    0x5F,0x4F,0x50,0x82,0x55,0x81,0xBF,0x1F,
    0x00,0x4F,0x0D,0x0E,0x00,0x00,0x00,0x50,
    0x9C,0x0E,0x8F,0x28,0x1F,0x96,0xB9,0xA3,0xFF,
    0x00,0x00,0x00,0x00,0x00,0x10,0x0E,0x00,0xFF,
    0x00,0x01,0x02,0x03,0x04,0x05,0x14,0x07,
    0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
    0x0C,0x00,0x0F,0x08,0x00
};

void VGA::write_regs(const uint8_t* regs) {
    outb(0x3C2, *regs++);

    for (uint8_t i = 0; i < 5; i++) {
        outb(0x3C4, i);
        outb(0x3C5, *regs++);
    }

    outb(0x3D4, 0x03);
    outb(0x3D5, inb(0x3D5) | 0x80);
    outb(0x3D4, 0x11);
    outb(0x3D5, inb(0x3D5) & ~0x80);

    for (uint8_t i = 0; i < 25; i++) {
        outb(0x3D4, i);
        outb(0x3D5, *regs++);
    }

    for (uint8_t i = 0; i < 9; i++) {
        outb(0x3CE, i);
        outb(0x3CF, *regs++);
    }

    inb(0x3DA);
    for (uint8_t i = 0; i < 21; i++) {
        inb(0x3DA);
        outb(0x3C0, i);
        outb(0x3C0, *regs++);
    }
    inb(0x3DA);
    outb(0x3C0, 0x20);
}

void VGA::init_mode13h() {
    write_regs(mode13h_regs);
    graphics_mode_ = true;
    clear(0);
}

void VGA::init_text_mode() {
    write_regs(mode03h_regs);
    graphics_mode_ = false;

    volatile uint16_t* vga_text = (volatile uint16_t*)0xB8000;
    for (int i = 0; i < 80 * 25; i++)
        vga_text[i] = (uint16_t)(' ') | (0x1F << 8);
}

bool VGA::is_graphics() {
    return graphics_mode_;
}

void VGA::put_pixel(int x, int y, uint8_t color) {
    if (x >= 0 && x < VGA_WIDTH && y >= 0 && y < VGA_HEIGHT)
        framebuffer_[y * VGA_WIDTH + x] = color;
}

uint8_t VGA::get_pixel(int x, int y) {
    if (x >= 0 && x < VGA_WIDTH && y >= 0 && y < VGA_HEIGHT)
        return framebuffer_[y * VGA_WIDTH + x];
    return 0;
}

void VGA::clear(uint8_t color) {
    for (int i = 0; i < VGA_WIDTH * VGA_HEIGHT; i++)
        framebuffer_[i] = color;
}

void VGA::fill_rect(int x, int y, int w, int h, uint8_t color) {
    for (int iy = y; iy < y + h; iy++)
        for (int ix = x; ix < x + w; ix++)
            put_pixel(ix, iy, color);
}

void VGA::draw_rect(int x, int y, int w, int h, uint8_t color) {
    for (int ix = x; ix < x + w; ix++) {
        put_pixel(ix, y, color);
        put_pixel(ix, y + h - 1, color);
    }
    for (int iy = y; iy < y + h; iy++) {
        put_pixel(x, iy, color);
        put_pixel(x + w - 1, iy, color);
    }
}

void VGA::draw_line(int x0, int y0, int x1, int y1, uint8_t color) {
    int dx = x1 - x0;
    int dy = y1 - y0;
    int sx = (dx > 0) ? 1 : -1;
    int sy = (dy > 0) ? 1 : -1;
    if (dx < 0) dx = -dx;
    if (dy < 0) dy = -dy;

    int err = dx - dy;
    while (true) {
        put_pixel(x0, y0, color);
        if (x0 == x1 && y0 == y1) break;
        int e2 = 2 * err;
        if (e2 > -dy) { err -= dy; x0 += sx; }
        if (e2 < dx) { err += dx; y0 += sy; }
    }
}

void VGA::draw_circle(int cx, int cy, int r, uint8_t color) {
    int x = 0, y = r, d = 3 - 2 * r;
    while (x <= y) {
        put_pixel(cx+x,cy+y,color); put_pixel(cx-x,cy+y,color);
        put_pixel(cx+x,cy-y,color); put_pixel(cx-x,cy-y,color);
        put_pixel(cx+y,cy+x,color); put_pixel(cx-y,cy+x,color);
        put_pixel(cx+y,cy-x,color); put_pixel(cx-y,cy-x,color);
        if (d < 0) d += 4*x + 6;
        else { d += 4*(x-y) + 10; y--; }
        x++;
    }
}

void VGA::fill_circle(int cx, int cy, int r, uint8_t color) {
    for (int y = -r; y <= r; y++)
        for (int x = -r; x <= r; x++)
            if (x*x + y*y <= r*r)
                put_pixel(cx+x, cy+y, color);
}

void VGA::draw_char(int x, int y, char c, uint8_t fg, uint8_t bg) {
    uint8_t idx = (uint8_t)c;
    if (idx >= 128) idx = '?';
    const uint8_t* glyph = font8x8[idx];
    for (int row = 0; row < 8; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < 8; col++) {
            uint8_t color = (bits & (0x80 >> col)) ? fg : bg;
            put_pixel(x + col, y + row, color);
        }
    }
}

void VGA::draw_string(int x, int y, const char* str, uint8_t fg, uint8_t bg) {
    while (*str) {
        draw_char(x, y, *str, fg, bg);
        x += 8;
        str++;
    }
}

void VGA::set_palette(uint8_t index, uint8_t r, uint8_t g, uint8_t b) {
    outb(0x3C8, index);
    outb(0x3C9, r >> 2);
    outb(0x3C9, g >> 2);
    outb(0x3C9, b >> 2);
}

void VGA::set_default_palette() {
    for (int i = 0; i < 64; i++) {
        set_palette(i, i * 4, 0, 0);
        set_palette(64 + i, 0, i * 4, 0);
        set_palette(128 + i, 0, 0, i * 4);
        set_palette(192 + i, i * 4, i * 4, i * 4);
    }
    set_palette(0, 0, 0, 0);
    set_palette(15, 255, 255, 255);
    set_palette(1, 0, 0, 170);
    set_palette(2, 0, 170, 0);
    set_palette(3, 0, 170, 170);
    set_palette(4, 170, 0, 0);
    set_palette(5, 170, 0, 170);
    set_palette(6, 170, 85, 0);
    set_palette(7, 170, 170, 170);
    set_palette(8, 85, 85, 85);
    set_palette(9, 85, 85, 255);
    set_palette(10, 85, 255, 85);
    set_palette(11, 85, 255, 255);
    set_palette(12, 255, 85, 85);
    set_palette(13, 255, 85, 255);
    set_palette(14, 255, 255, 85);
}

void VGA::demo() {
    init_mode13h();
    set_default_palette();

    for (int x = 0; x < VGA_WIDTH; x++) {
        for (int y = 0; y < VGA_HEIGHT; y++) {
            uint8_t color = (uint8_t)((x * y) >> 6);
            put_pixel(x, y, color);
        }
    }

    fill_rect(20, 20, 120, 60, 0);
    draw_rect(20, 20, 120, 60, 15);

    draw_string(28, 30, "RAND OS 36", 14, 0);
    draw_string(28, 42, "VGA 320x200", 11, 0);
    draw_string(28, 54, "256 colors", 10, 0);
    draw_string(28, 66, "Mode 13h OK", 12, 0);

    fill_circle(220, 100, 40, 1);
    draw_circle(220, 100, 40, 9);
    fill_circle(220, 100, 25, 2);
    draw_circle(220, 100, 25, 10);
    fill_circle(220, 100, 10, 4);
    draw_circle(220, 100, 10, 12);

    for (int i = 0; i < 16; i++)
        fill_rect(20 + i * 18, 160, 16, 16, i);
    draw_string(20, 150, "Palette:", 15, 0);

    draw_line(170, 160, 310, 160, 7);
    draw_line(170, 160, 170, 190, 7);
    for (int x = 170; x < 310; x++) {
        int h = ((x * 7 + 13) % 20) + 5;
        draw_line(x, 190 - h, x, 190, 3);
    }

    draw_string(4, 190, "'textmode' to return", 7, 0);
}

} // namespace re36
