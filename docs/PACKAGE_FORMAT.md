# RAND Elecorner 36 — Формат Пакетов Приложений

> Спецификация `.vlsmc-pkg`
> Build 0001

---

## Обзор

Пакет приложения (`.vlsmc-pkg`) — это ZIP-архив с фиксированной структурой, содержащий скомпилированный JavaScript, метаданные и ресурсы.

---

## Структура пакета

```
my-app.vlsmc-pkg (ZIP)
├── manifest.json          # [обязательный] Метаданные приложения
├── main.js                # [обязательный] Точка входа (скомпилированный TS)
├── icon.png               # [опциональный] Иконка 128×128 px
├── README.md              # [опциональный] Описание для магазина
└── assets/                # [опциональный] Дополнительные ресурсы
    ├── style.css
    └── data.json
```

---

## manifest.json — Спецификация

```jsonc
{
  // === Обязательные поля ===
  "name": "Калькулятор",                     // Отображаемое имя
  "id": "com.example.calculator",           // Уникальный идентификатор (reverse-domain)
  "version": "1.0.0",                       // Семантическая версия
  "main": "main.js",                        // Точка входа
  "apiVersion": "1",                        // Версия VLSMC API

  // === Опциональные поля ===
  "author": "Иванов Иван",                  // Автор
  "description": "Простой калькулятор",      // Описание
  "icon": "icon.png",                       // Путь к иконке внутри пакета
  "license": "MIT",                         // Лицензия

  "permissions": [                          // Запрашиваемые разрешения
    "ui.window",
    "filesystem.read"
  ],

  "window": {                              // Параметры окна по умолчанию
    "width": 400,
    "height": 500,
    "minWidth": 300,
    "minHeight": 400,
    "resizable": true
  },

  "requirements": {                        // Системные требования
    "minApiVersion": "1",
    "minMemory": 4                         // МБ
  }
}
```

### Правила именования `id`

| Правило | Пример |
|---------|--------|
| Формат reverse-domain | `com.author.appname` |
| Только строчные буквы, цифры, точки | `org.vlsmc.notepad` |
| Минимум 3 сегмента | `com.example.app` |
| Максимум 64 символа | — |

---

## Процесс установки

```
                      Пользователь
                          │
                          ▼
                   ┌──────────────┐
                   │  Открыть     │
                   │  .vlsmc-pkg  │
                   └──────┬───────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  1. Распаковка во     │
              │     временную папку   │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  2. Валидация         │
              │  • manifest.json      │──── Ошибка? → Отмена
              │  • main.js            │
              │  • apiVersion         │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  3. Запрос разрешений │
              │  у пользователя       │──── Отказ? → Отмена
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  4. Копирование в     │
              │  /apps/{id}/          │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  5. Регистрация в     │
              │  реестре приложений   │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  6. Иконка на         │
              │  рабочем столе / меню │
              └───────────────────────┘
```

---

## Реестр приложений

Файл `/system/registry/apps.json` в виртуальной ФС:

```jsonc
{
  "com.example.calculator": {
    "name": "Калькулятор",
    "version": "1.0.0",
    "path": "/apps/com.example.calculator/",
    "icon": "/apps/com.example.calculator/icon.png",
    "permissions": ["ui.window", "filesystem.read"],
    "installedAt": "2026-02-24T20:20:00",
    "installedBy": "root"
  }
}
```

---

## Валидация пакета

При установке проверяются:

| Проверка | Статус | Описание |
|----------|--------|----------|
| `manifest.json` существует | Обязательно | Пакет без манифеста отклоняется |
| `main.js` существует | Обязательно | Точка входа должна быть |
| `id` уникален | Обязательно | Нельзя установить два приложения с одним `id` |
| `apiVersion` совместима | Обязательно | Версия API должна поддерживаться |
| `permissions` валидны | Обязательно | Все разрешения — из списка допустимых |
| `icon.png` — валидное изображение | Рекомендуемо | Используется дефолтная иконка при отсутствии |
| Размер пакета ≤ 50 МБ | Обязательно | Защита от злоупотреблений |

---

## Команды менеджера пакетов (терминал)

```bash
# Установить приложение
pkg install /path/to/app.vlsmc-pkg

# Удалить приложение
pkg uninstall com.example.calculator

# Список установленных
pkg list

# Информация о приложении
pkg info com.example.calculator

# Запустить из терминала
pkg run com.example.calculator
```

---

## Инструмент упаковки (хост-система)

Утилита `vlsmc-pack` (Python) для разработчиков:

```bash
# Упаковать приложение
python -m vlsmc.tools.pack \
  --manifest ./manifest.json \
  --main ./dist/main.js \
  --icon ./icon.png \
  --assets ./assets/ \
  --out calculator.vlsmc-pkg

# Проверить пакет
python -m vlsmc.tools.validate calculator.vlsmc-pkg
```

---

## Жизненный цикл приложения

```
                ┌───────────┐
                │ Упакован  │  (.vlsmc-pkg на хосте)
                └─────┬─────┘
                      │ pkg install
                      ▼
                ┌───────────┐
                │ Установлен│  (в реестре, иконка на столе)
                └─────┬─────┘
                      │ двойной клик / pkg run
                      ▼
                ┌───────────┐
                │  Запущен  │  (процесс + окно)
                └─────┬─────┘
                      │ закрытие / kill
                      ▼
                ┌───────────┐
                │ Остановлен│  (процесс завершён)
                └─────┬─────┘
                      │ pkg uninstall
                      ▼
                ┌───────────┐
                │  Удалён   │  (файлы и запись удалены)
                └───────────┘
```
