# Технические требования: Драйвер AHCI/DMA (SATA)

Этот документ содержит детальные спецификации для реализации драйвера Advanced Host Controller Interface (AHCI) с поддержкой Direct Memory Access (DMA) для операционной системы VLSMC.

## 1. Обнаружение и инициализация шины

### 1.1. PCI Сканирование
- Поиск по **Class 0x01**, **Subclass 0x06**, **ProgIF 0x01**.
- **BAR5 (AHCI Base Address)**:
    - Проверка бита 0: Должен быть `0` (Memory Space).
    - Поддержка **64-битного BAR**: Если биты 1-2 равны `0x02`, адрес занимает 8 байт (BAR5 + BAR6).
- Включение Master Bus в командном регистре PCI (`cmd |= 0x04`).

## 2. Архитектура HBA и Регистры

### 2.1. Глобальные регистры (BAR5 + ...)
| Регистр | Оффсет | Описание |
|---------|--------|----------|
| **CAP** | 0x00 | Capabilities (NPS: биты 0-4 - кол-во портов, S64A: бит 31 - 64-bit DMA) |
| **GHC** | 0x04 | Global Host Control (AE: бит 31 - AHCI Enable, HR: бит 0 - Reset) |
| **IS**  | 0x08 | Interrupt Status (общий) |
| **PI**  | 0x0C | Ports Implemented (битовая маска доступных портов) |

### 2.2. Регистры портов (BAR5 + 0x100 + port*0x80)
- **PxCLB/U** (0x00/0x04): Command List Base (выравнивание **1 Кб**).
- **PxFB/U** (0x08/0x0C): FIS Area Base (выравнивание **256 байт**).
- **PxTFD** (0x20): Task File Data (бит 7: BSY, бит 3: DRQ, бит 0: ERR).
- **PxSSTS** (0x28): SATA Status (биты 0-3: 0x03 если диск подключен).
- **PxCMD** (0x18): Command and Status.
    - Бит 0 (ST): Start (запуск порта).
    - Бит 4 (FRE): FIS Receive Enable.

## 3. Структуры данных (C-style)

```cpp
// Заголовок команды (32 байта)
struct HBA_CMD_HEADER {
    uint8_t  cfl:5;    // Длина FIS в dwords
    uint8_t  a:1;      // ATAPI
    uint8_t  w:1;      // Направление (1 - Host to Device)
    uint8_t  p:1;      // Prefetchable
    uint8_t  r:1;      // Reset
    uint8_t  b:1;      // BIST
    uint8_t  c:1;      // Clear busy upon R_OK
    uint8_t  res0:1;
    uint8_t  pmp:4;    // Port multiplier port
    uint16_t prdtl;    // Количество PRDT записей
    uint32_t prdbc;    // Передано байт
    uint32_t ctba;     // Физический адрес Command Table (Low)
    uint32_t ctbau;    // Физический адрес Command Table (High)
    uint32_t res1[4];
};

// Элемент PRDT (16 байт)
struct HBA_PRDT_ENTRY {
    uint32_t dba;      // Физический адрес буфера (Low)
    uint32_t dbau;     // Физический адрес буфера (High)
    uint32_t res0;
    uint32_t dbc:22;   // Размер данных (Count - 1)
    uint32_t res1:9;
    uint32_t i:1;      // Прерывание по завершении
};
```

## 4. Алгоритм и Транзакции

### 4.1. Поддержка LBA48
- При формировании `Command FIS` (H2D) для современных дисков необходимо использовать расширенные регистры LBA (LBA Low, Mid, High Exp) для адресации выше 128 Гб.

### 4.2. DMA и PRDT
- Максимальный размер PRDT записи: **4 МиБ - 1** (0x3FFFFF).
- Если размер буфера не кратен 4 МиБ, последняя запись `dbc` должна содержать фактический остаток байт (размер - 1).

### 4.3. Прерывания (MSI/Legacy)
- Предпочтительно использование **MSI** через APIC.
- Обработчик прерывания должен читать `PxIS` для подтверждения источника события и `IS` общего регистра.

## 5. Политики и Безопасность

### 5.1. Синхронизация
- Защита на уровне **отдельного порта** через мьютексы/атомики. Параллельные операции на разных портах разрешены. 
- Перед записью в регистр `PxCI` обязателен барьер памяти (`mfence`).

### 5.2. Error Handling
- **Abort**: Если бит `PxTFD.ERR` установлен, остановить порт (`PxCMD.ST=0`), дождаться остановки, очистить список команд и сбросить ошибку.
- **Retry**: Лимит повторов — 3 раза. При фатальном сбое — сброс порта (Port Reset).
- **Timeouts**: 2 секунды для обычных команд, 10 секунд для операций инициализации.

### 5.3. Память
- Обязательная проверка выравнивания (CLB, FIS) через `assert` или кастомный аллокатор ядра. Никаких виртуальных адресов в структурах контроллера.
