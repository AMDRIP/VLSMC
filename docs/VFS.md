–û—Ç–ª–∏—á–Ω—ã–π —à–∞–≥. –ï—Å–ª–∏ —Ç—ã —Å–µ–π—á–∞—Å –≥—Ä–∞–º–æ—Ç–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—à—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ VFS, —Ç—ã —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫–ª–∞–¥—ã–≤–∞–µ—à—å **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –≤—Å–µ–π –û–°**. –ù–∏–∂–µ ‚Äî —Å—Ç—Ä–æ–≥–∞—è, –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è —è–¥—Ä–∞.

---

# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ VFS (Virtual File System) –¥–ª—è VLSMC

---

## 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–æ—è VFS

VFS ‚Äî —ç—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π —Å–ª–æ–π –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ –∏ –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π:

* –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å API –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –§–°
* –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
* –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
* –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –§–° –≤ –µ–¥–∏–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
* –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–ª–æ—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
* –∏–∑–æ–ª—è—Ü–∏—é —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞


---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 2.1. –ü–æ–ª–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –§–°

–Ø–¥—Ä–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –∑–Ω–∞—Ç—å:

* —Å—Ç—Ä—É–∫—Ç—É—Ä—É inode FAT32
* —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤ ext2
* layout –∫–ª–∞—Å—Ç–µ—Ä–∞
* layout —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

–Ø–¥—Ä–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å VFS-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏.

---

### 2.2. –ü–ª–∞–≥–∏–Ω-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º

–ö–∞–∂–¥–∞—è –§–° —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ VFS —á–µ—Ä–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥—Ä–∞–π–≤–µ—Ä–∞:

```c
struct vfs_filesystem_driver {
    const char* name;
    int (*mount)(struct block_device*, struct superblock*);
    int (*unmount)(struct superblock*);
};
```

---

### 2.3. –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å

VFS –æ–±—è–∑–∞–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –µ–¥–∏–Ω–æ–µ –¥–µ—Ä–µ–≤–æ:

```
/
‚îú‚îÄ‚îÄ dev
‚îú‚îÄ‚îÄ home
‚îú‚îÄ‚îÄ tmp
‚îî‚îÄ‚îÄ mountpoints
```

–ö–∞–∂–¥—ã–π mountpoint –∑–∞–º–µ–Ω—è–µ—Ç vnode –∫–∞—Ç–∞–ª–æ–≥–∞.

---

---

# 3. –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

---

## 3.1 vnode (—è–¥—Ä–æ VFS)

–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –ª—é–±–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:

* —Ç–∏–ø (file/dir/device/symlink)
* —Ä–∞–∑–º–µ—Ä
* –ø—Ä–∞–≤–∞
* —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ inode –§–°
* —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ç–∞–±–ª–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π

---

## 3.2 file descriptor object

–û–±—ä–µ–∫—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞.

–ü–æ–ª—è:

* vnode*
* offset
* flags
* refcount

---

## 3.3 superblock

–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É.

–ü–æ–ª—è:

* fs_driver*
* block_device*
* root vnode
* fs private data

---

## 3.4 dentry cache

–ö—ç—à —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø—É—Ç–µ–π:

```
/home/user/file.txt ‚Üí vnode*
```

–ù—É–∂–µ–Ω –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è path lookup.

---

---

# 4. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø–µ—Ä–∞—Ü–∏–π vnode

–ö–∞–∂–¥—ã–π –¥—Ä–∞–π–≤–µ—Ä –§–° –æ–±—è–∑–∞–Ω —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

```c
lookup
create
unlink
read
write
mkdir
rmdir
readdir
truncate
stat
```

---

# 5. API —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤

VFS –¥–æ–ª–∂–µ–Ω –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å:

```
open
close
read
write
lseek
stat
mkdir
unlink
mount
umount
dup
dup2
```

---

# 6. Path Resolver

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞.

–ü–æ–¥–¥–µ—Ä–∂–∫–∞:

* –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏
* –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
* . –∏ ..
* —Å–∏–º–ª–∏–Ω–∫–∏ (–ø–æ–∑–∂–µ)

–ê–ª–≥–æ—Ä–∏—Ç–º:

```
split path ‚Üí iterate components ‚Üí lookup vnode ‚Üí next
```

---

# 7. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

VFS –æ–±—è–∑–∞–Ω –∏–º–µ—Ç—å:

### inode cache

—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å –¥–∏—Å–∫–∞

### dentry cache

—á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–±–∏—Ä–∞—Ç—å –ø—É—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑

---

# 8. –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏:

* thread-safe –¥–æ—Å—Ç—É–ø –∫ vnode
* –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ inode –ø—Ä–∏ –∑–∞–ø–∏—Å–∏
* atomic refcount

---

# 9. –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

VFS –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å:

* –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
* mount –≤ –ª—é–±—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
* –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥—Ä–∞–π–≤–µ—Ä–æ–≤

---

# 10. –û—à–∏–±–∫–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

–ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –æ–±—è–∑–∞–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–æ–¥ –æ—à–∏–±–∫–∏:

```
ENOENT
EIO
ENOMEM
EINVAL
EEXIST
ENOTDIR
```

---

# 11. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

* lookup –ø—É—Ç–∏ ‚â§ O(depth)
* –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞ –±–µ–∑ IO –µ—Å–ª–∏ –≤ cache
* read/write –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—Ç syscall

---

# 12. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (MVP VFS)

–ß—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–ª–∞—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:

‚úî open/read/write/close
‚úî root fs
‚úî mount ramfs
‚úî path resolver
‚úî file descriptors per process

---

# 13. –†–∞—Å—à–∏—Ä–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Ä–∞–∑—É)

–ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

* symlink
* mmap
* async IO
* journaling
* file locking
* network FS

---

# 14. –°—Ç—Ä–æ–≥–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:

üö´ —Ö—Ä–∞–Ω–∏—Ç—å FAT32-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ vnode
üö´ –≤—ã–∑—ã–≤–∞—Ç—å –¥—Ä–∞–π–≤–µ—Ä –¥–∏—Å–∫–∞ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ syscalls
üö´ –¥–µ–ª–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ inode –±–µ–∑ refcount
üö´ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å scheduler –≤–æ –≤—Ä–µ–º—è IO
üö´ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –¥—Ä–∞–π–≤–µ—Ä–∞—Ö –§–°

---

# 15. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã VFS —Å–ª–æ—è

```
Syscalls
   ‚Üì
VFS Core
   ‚Üì
Filesystem Drivers
   ‚Üì
Block Layer
   ‚Üì
Disk Controller
```

---

# –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ü–µ–ª—å

–•–æ—Ä–æ—à–∏–π VFS —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑—Ä–µ–ª—ã–º, –µ—Å–ª–∏:

* –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—É—é –§–° –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–¥—Ä–∞
* –º–æ–∂–Ω–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –§–° –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
* syscalls –Ω–µ –∑–Ω–∞—é—Ç —Ç–∏–ø –§–°
* –¥—Ä–∞–π–≤–µ—Ä –§–° –Ω–µ –∑–Ω–∞–µ—Ç –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö

---

‚úî **–ì–ª–∞–≤–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –∫–∞—á–µ—Å—Ç–≤–∞ VFS**

> –ï—Å–ª–∏ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –º–æ–¥—É–ª—å ‚Äî VFS —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

---
